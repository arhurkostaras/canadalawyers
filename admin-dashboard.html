<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Google Analytics 4 -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-XCF2Z737"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-XCF2Z737');
    </script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - CanadaAccountants</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-900 text-white min-h-screen">
    <!-- Auth gate -->
    <script>
        (function() {
            const token = localStorage.getItem('cpa_token');
            const user = JSON.parse(localStorage.getItem('cpa_user') || '{}');
            if (!token || user.userType !== 'admin') {
                window.location.href = '/cpa-login.html';
            }
        })();
    </script>

    <!-- Top nav -->
    <nav class="bg-gray-800 border-b border-gray-700 px-6 py-4 flex items-center justify-between">
        <div class="flex items-center gap-4">
            <span class="text-xl font-bold bg-gradient-to-r from-indigo-400 to-purple-400 bg-clip-text text-transparent">CanadaAccountants Admin</span>
            <a href="/admin-outreach.html" class="text-sm text-gray-400 hover:text-white ml-4">Outreach</a>
            <a href="/admin-test-matching.html" class="text-sm text-gray-400 hover:text-white ml-2">AI Matching Test</a>
        </div>
        <div class="flex items-center gap-4">
            <span id="adminEmail" class="text-sm text-gray-400"></span>
            <button onclick="logout()" class="text-sm bg-red-600 hover:bg-red-700 px-3 py-1.5 rounded">Logout</button>
        </div>
    </nav>

    <main class="max-w-7xl mx-auto px-6 py-8">
        <!-- Stats cards -->
        <section id="statsSection" class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
            <div class="bg-gray-800 rounded-xl p-5 border border-gray-700">
                <p class="text-gray-400 text-sm">Total CPAs</p>
                <p id="statCpas" class="text-3xl font-bold mt-1">--</p>
                <p id="statVerified" class="text-xs text-green-400 mt-1"></p>
            </div>
            <div class="bg-gray-800 rounded-xl p-5 border border-gray-700">
                <p class="text-gray-400 text-sm">SME Requests</p>
                <p id="statRequests" class="text-3xl font-bold mt-1">--</p>
                <p id="statNewRequests" class="text-xs text-blue-400 mt-1"></p>
            </div>
            <div class="bg-gray-800 rounded-xl p-5 border border-gray-700">
                <p class="text-gray-400 text-sm">Total Matches</p>
                <p id="statMatches" class="text-3xl font-bold mt-1">--</p>
            </div>
            <div class="bg-gray-800 rounded-xl p-5 border border-gray-700">
                <p class="text-gray-400 text-sm">Partnerships</p>
                <p id="statPartnerships" class="text-3xl font-bold mt-1">--</p>
            </div>
        </section>

        <!-- CPA Management -->
        <section class="mb-8">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-xl font-semibold">CPA Management</h2>
                <select id="cpaFilter" onchange="loadCPAs()" class="bg-gray-800 border border-gray-600 rounded px-3 py-1.5 text-sm">
                    <option value="">All CPAs</option>
                    <option value="true">Verified</option>
                    <option value="false">Unverified</option>
                </select>
            </div>
            <div class="bg-gray-800 rounded-xl border border-gray-700 overflow-x-auto">
                <table class="w-full text-sm">
                    <thead class="text-gray-400 border-b border-gray-700">
                        <tr>
                            <th class="text-left px-4 py-3">Name</th>
                            <th class="text-left px-4 py-3">Email</th>
                            <th class="text-left px-4 py-3">Firm</th>
                            <th class="text-left px-4 py-3">Province</th>
                            <th class="text-left px-4 py-3">Verified</th>
                            <th class="text-left px-4 py-3">Action</th>
                        </tr>
                    </thead>
                    <tbody id="cpaTableBody" class="divide-y divide-gray-700"></tbody>
                </table>
            </div>
            <div id="cpaPagination" class="flex items-center justify-between mt-3 text-sm text-gray-400"></div>
        </section>

        <!-- Recent Submissions -->
        <section class="mb-8">
            <h2 class="text-xl font-semibold mb-4">Recent Friction Requests</h2>
            <div class="bg-gray-800 rounded-xl border border-gray-700 overflow-x-auto">
                <table class="w-full text-sm">
                    <thead class="text-gray-400 border-b border-gray-700">
                        <tr>
                            <th class="text-left px-4 py-3">Date</th>
                            <th class="text-left px-4 py-3">Contact</th>
                            <th class="text-left px-4 py-3">Pain Point</th>
                            <th class="text-left px-4 py-3">Business</th>
                            <th class="text-left px-4 py-3">Urgency</th>
                            <th class="text-left px-4 py-3">Friction</th>
                        </tr>
                    </thead>
                    <tbody id="submissionsTableBody" class="divide-y divide-gray-700"></tbody>
                </table>
            </div>
        </section>

        <!-- Recent Matches -->
        <section class="mb-8">
            <h2 class="text-xl font-semibold mb-4">Recent Match Activity</h2>
            <div class="bg-gray-800 rounded-xl border border-gray-700 overflow-x-auto">
                <table class="w-full text-sm">
                    <thead class="text-gray-400 border-b border-gray-700">
                        <tr>
                            <th class="text-left px-4 py-3">Date</th>
                            <th class="text-left px-4 py-3">CPA</th>
                            <th class="text-left px-4 py-3">Client</th>
                            <th class="text-left px-4 py-3">Score</th>
                            <th class="text-left px-4 py-3">Status</th>
                            <th class="text-left px-4 py-3">Partnership</th>
                        </tr>
                    </thead>
                    <tbody id="matchesTableBody" class="divide-y divide-gray-700"></tbody>
                </table>
            </div>
        </section>
    </main>

    <script>
        const API = 'https://canadaaccountants-backend-production-1d8f.up.railway.app';
        const token = localStorage.getItem('cpa_token');
        const headers = { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' };

        // Display admin email
        const user = JSON.parse(localStorage.getItem('cpa_user') || '{}');
        document.getElementById('adminEmail').textContent = user.email || '';

        function logout() {
            localStorage.removeItem('cpa_token');
            localStorage.removeItem('cpa_user');
            window.location.href = '/cpa-login.html';
        }

        function fmtDate(d) {
            if (!d) return '--';
            return new Date(d).toLocaleDateString('en-CA', { month: 'short', day: 'numeric', year: 'numeric' });
        }

        function badge(text, color) {
            const colors = {
                green: 'bg-green-900 text-green-300',
                red: 'bg-red-900 text-red-300',
                yellow: 'bg-yellow-900 text-yellow-300',
                blue: 'bg-blue-900 text-blue-300',
                gray: 'bg-gray-700 text-gray-300',
            };
            return `<span class="px-2 py-0.5 rounded-full text-xs ${colors[color] || colors.gray}">${text}</span>`;
        }

        // ---- Load dashboard stats ----
        async function loadStats() {
            try {
                const res = await fetch(`${API}/api/admin/dashboard-stats`, { headers });
                const data = await res.json();
                if (!data.success) throw new Error(data.error);
                const s = data.stats;
                document.getElementById('statCpas').textContent = s.total_cpas;
                document.getElementById('statVerified').textContent = `${s.verified_cpas} verified`;
                document.getElementById('statRequests').textContent = s.total_sme_requests;
                document.getElementById('statNewRequests').textContent = `${s.new_requests_7d} this week`;
                document.getElementById('statMatches').textContent = s.total_matches;
                document.getElementById('statPartnerships').textContent = s.total_partnerships;
            } catch (e) {
                console.error('Stats load error:', e);
            }
        }

        // ---- Load CPAs table ----
        let currentCPAPage = 1;
        async function loadCPAs(page) {
            if (page) currentCPAPage = page;
            const filter = document.getElementById('cpaFilter').value;
            const qs = `page=${currentCPAPage}&limit=10${filter ? `&verified=${filter}` : ''}`;
            try {
                const res = await fetch(`${API}/api/admin/cpas?${qs}`, { headers });
                const data = await res.json();
                if (!data.success) throw new Error(data.error);

                const tbody = document.getElementById('cpaTableBody');
                if (data.cpas.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" class="px-4 py-6 text-center text-gray-500">No CPAs found</td></tr>';
                } else {
                    tbody.innerHTML = data.cpas.map(c => `
                        <tr class="hover:bg-gray-750">
                            <td class="px-4 py-3">${c.first_name || ''} ${c.last_name || ''}</td>
                            <td class="px-4 py-3 text-gray-400">${c.email || '--'}</td>
                            <td class="px-4 py-3">${c.firm_name || '--'}</td>
                            <td class="px-4 py-3">${c.province || '--'}</td>
                            <td class="px-4 py-3">${c.verification_status === 'verified' ? badge('Verified', 'green') : badge('Unverified', 'yellow')}</td>
                            <td class="px-4 py-3">
                                <button onclick="toggleVerify('${c.id}', ${!c.verification_status === 'verified'})"
                                    class="text-xs px-2 py-1 rounded ${c.verification_status === 'verified' ? 'bg-yellow-700 hover:bg-yellow-600' : 'bg-green-700 hover:bg-green-600'}">
                                    ${c.verification_status === 'verified' ? 'Unverify' : 'Verify'}
                                </button>
                            </td>
                        </tr>
                    `).join('');
                }

                const p = data.pagination;
                document.getElementById('cpaPagination').innerHTML = `
                    <span>Page ${p.page} of ${p.totalPages} (${p.total} total)</span>
                    <div class="flex gap-2">
                        <button onclick="loadCPAs(${p.page - 1})" ${p.page <= 1 ? 'disabled class="opacity-30 cursor-default"' : 'class="hover:text-white"'}>&larr; Prev</button>
                        <button onclick="loadCPAs(${p.page + 1})" ${p.page >= p.totalPages ? 'disabled class="opacity-30 cursor-default"' : 'class="hover:text-white"'}>Next &rarr;</button>
                    </div>
                `;
            } catch (e) {
                console.error('CPAs load error:', e);
            }
        }

        async function toggleVerify(cpaId, verified) {
            try {
                await fetch(`${API}/api/admin/cpas/${cpaId}/verify`, {
                    method: 'POST',
                    headers,
                    body: JSON.stringify({ verified }),
                });
                loadCPAs();
                loadStats();
            } catch (e) {
                console.error('Verify toggle error:', e);
            }
        }

        // ---- Load recent submissions ----
        async function loadSubmissions() {
            try {
                const res = await fetch(`${API}/api/admin/submissions?limit=10`, { headers });
                const data = await res.json();
                if (!data.success) throw new Error(data.error);

                const tbody = document.getElementById('submissionsTableBody');
                if (data.submissions.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7" class="px-4 py-6 text-center text-gray-500">No submissions yet</td></tr>';
                } else {
                    tbody.innerHTML = data.submissions.map(s => {
                        const contact = s.contact_info || {};
                        const urgencyColor = { emergency: 'red', urgent: 'yellow', soon: 'blue', flexible: 'gray' };
                        return `
                            <tr class="hover:bg-gray-750">
                                <td class="px-4 py-3 text-gray-400">${fmtDate(s.created_at)}</td>
                                <td class="px-4 py-3">${contact.name || '--'}<br><span class="text-xs text-gray-500">${contact.email || ''}</span></td>
                                <td class="px-4 py-3">${s.pain_point || '--'}</td>
                                <td class="px-4 py-3">${s.business_type || '--'}</td>
                                <td class="px-4 py-3">${badge(s.urgency_level || '--', urgencyColor[s.urgency_level] || 'gray')}</td>
                                <td class="px-4 py-3">${s.friction_score || 0}</td>
                            </tr>
                        `;
                    }).join('');
                }
            } catch (e) {
                console.error('Submissions load error:', e);
            }
        }

        // ---- Load recent matches ----
        async function loadMatches() {
            try {
                const res = await fetch(`${API}/api/admin/matches?limit=10`, { headers });
                const data = await res.json();
                if (!data.success) throw new Error(data.error);

                const tbody = document.getElementById('matchesTableBody');
                if (data.matches.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" class="px-4 py-6 text-center text-gray-500">No matches yet</td></tr>';
                } else {
                    tbody.innerHTML = data.matches.map(m => {
                        const contact = m.contact_info || {};
                        return `
                            <tr class="hover:bg-gray-750">
                                <td class="px-4 py-3 text-gray-400">${fmtDate(m.created_at)}</td>
                                <td class="px-4 py-3">${m.cpa_name || '--'}</td>
                                <td class="px-4 py-3">${contact.name || '--'}<br><span class="text-xs text-gray-500">${m.pain_point || ''}</span></td>
                                <td class="px-4 py-3 font-mono">${m.match_score ? parseFloat(m.match_score).toFixed(1) : '--'}%</td>
                                <td class="px-4 py-3">${badge(m.status || 'presented', m.status === 'partnership_formed' ? 'green' : 'gray')}</td>
                                <td class="px-4 py-3">${m.partnership_formed ? badge('Yes', 'green') : badge('No', 'gray')}</td>
                            </tr>
                        `;
                    }).join('');
                }
            } catch (e) {
                console.error('Matches load error:', e);
            }
        }

        // ---- Init ----
        loadStats();
        loadCPAs();
        loadSubmissions();
        loadMatches();
    </script>
</body>
</html>
