<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <!-- Google Analytics 4 -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-XCF2Z737"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-XCF2Z737');
    </script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CPA Login - CanadaAccountants</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
    <div class="min-h-screen flex items-center justify-center py-12 px-4 sm:px-6 lg:px-8">
        <div class="max-w-md w-full space-y-8">
            <!-- Logo and Header -->
            <div class="text-center">
                <h2 class="mt-6 text-3xl font-extrabold text-gray-900">
                    CPA Dashboard Login
                </h2>
                <p class="mt-2 text-sm text-gray-600">
                    Access your CanadaAccountants member dashboard
                </p>
            </div>

            <!-- Login Form -->
            <form class="mt-8 space-y-6" id="loginForm">
                <div class="rounded-md shadow-sm -space-y-px">
                    <div>
                        <label for="email" class="sr-only">Email address</label>
                        <input 
                            id="email" 
                            name="email" 
                            type="email" 
                            required 
                            class="appearance-none rounded-none relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-t-md focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 focus:z-10 sm:text-sm" 
                            placeholder="Email address"
                        >
                    </div>
                    <div>
                        <label for="password" class="sr-only">Password</label>
                        <input 
                            id="password" 
                            name="password" 
                            type="password" 
                            required 
                            class="appearance-none rounded-none relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-b-md focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 focus:z-10 sm:text-sm" 
                            placeholder="Password"
                        >
                    </div>
                </div>

                <div class="flex items-center justify-between">
                    <div class="flex items-center">
                        <input 
                            id="remember-me" 
                            name="remember-me" 
                            type="checkbox" 
                            class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded"
                        >
                        <label for="remember-me" class="ml-2 block text-sm text-gray-900">
                            Remember me
                        </label>
                    </div>

                    <div class="text-sm">
                        <a href="/forgot-password.html" class="font-medium text-indigo-600 hover:text-indigo-500">
                            Forgot your password?
                        </a>
                    </div>
                </div>

                <div>
                    <button 
                        type="submit" 
                        class="group relative w-full flex justify-center py-2 px-4 border border-transparent text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 disabled:opacity-50"
                        id="loginBtn"
                    >
                        Sign in to Dashboard
                    </button>
                </div>

                <!-- Error Display -->
                <div id="errorMessage" class="hidden mt-3 text-center text-sm text-red-600 bg-red-50 border border-red-200 rounded-md p-3">
                </div>

                <!-- Success Display -->
                <div id="successMessage" class="hidden mt-3 text-center text-sm text-green-600 bg-green-50 border border-green-200 rounded-md p-3">
                </div>
            </form>

            <!-- Registration Link -->
            <div class="text-center">
                <p class="mt-2 text-sm text-gray-600">
                    Don't have an account? 
                    <a href="/cpa-onboarding" class="font-medium text-indigo-600 hover:text-indigo-500">
                        Register as a CPA
                    </a>
                </p>
            </div>
        </div>
    </div>

    <script>
        document.getElementById('loginForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const loginBtn = document.getElementById('loginBtn');
            const errorMessage = document.getElementById('errorMessage');
            const successMessage = document.getElementById('successMessage');
            
            // Reset messages
            errorMessage.classList.add('hidden');
            successMessage.classList.add('hidden');
            
            // Show loading state
            loginBtn.disabled = true;
            loginBtn.textContent = 'Signing in...';
            
            const formData = {
                email: document.getElementById('email').value,
                password: document.getElementById('password').value
            };
            
            try {
                const response = await fetch('https://canadaaccountants-backend-production-1d8f.up.railway.app/api/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formData)
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    // Store JWT token
                    localStorage.setItem('cpa_token', data.token);
                    localStorage.setItem('cpa_user', JSON.stringify(data.user));

                    // Route based on user type
                    const isAdmin = data.user.userType === 'admin';
                    const destination = isAdmin ? '/admin-dashboard.html' : '/cpa-dashboard.html';

                    // Show success message
                    successMessage.textContent = `Login successful! Redirecting to ${isAdmin ? 'admin' : ''} dashboard...`;
                    successMessage.classList.remove('hidden');

                    // Redirect to appropriate dashboard
                    setTimeout(() => {
                        window.location.href = destination;
                    }, 1500);
                    
                } else {
                    throw new Error(data.error || 'Login failed');
                }
                
            } catch (error) {
                console.error('Login error:', error);
                errorMessage.textContent = error.message;
                errorMessage.classList.remove('hidden');
                
                // Reset button
                loginBtn.disabled = false;
                loginBtn.textContent = 'Sign in to Dashboard';
            }
        });

        // Check if already logged in
        document.addEventListener('DOMContentLoaded', function() {
            const token = localStorage.getItem('cpa_token');
            if (token) {
                const storedUser = JSON.parse(localStorage.getItem('cpa_user') || '{}');
                const dest = storedUser.userType === 'admin' ? '/admin-dashboard.html' : '/cpa-dashboard.html';
                // Verify token is still valid and redirect if so
                fetch('https://canadaaccountants-backend-production-1d8f.up.railway.app/api/auth/verify', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                })
                .then(response => {
                    if (response.ok) {
                        window.location.href = dest;
                    }
                })
                .catch(() => {
                    // Token invalid, remove it
                    localStorage.removeItem('cpa_token');
                    localStorage.removeItem('cpa_user');
                });
            }
        });
    </script>
</body>
</html>
